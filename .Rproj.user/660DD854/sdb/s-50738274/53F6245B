{
    "contents" : "##########################\n#  R script: generate key GIS layers for modeling COTS population in the GBR \n#\n#  Authors: Kevin Shoemaker, Sam Matthews, Camille Mellin, Damien Fordham\n#  \n#  08 April 2015 -- started scripting\n#\n#  26 September 2016 -- redefined GIS layers to comply with GBRMPA MArineBioregions_WGS84 Shapefile\n#\n#         URGENT: ENV DATA does not cover 2/3 of our reef site\n#         URGENT: Reef percent raster does not seem to line up with shapefile in many areas\n\n##########################\n\n\n###############################\n#  PREPARE KEY GIS LAYERS\n###############################\n\n################\n### create \"reefraster\" layer: represents percent of each grid cell with reef coverage. \n\n### UPDATE 28 September 2009 -- Convert to using the MarineBioregions_WGS84 Shapefile as Basis\n################\n\n### Create template raster for the GBR (proper extent and resolution)\n################\n\nsetwd(ENVDATA_DIRECTORY)    # first load the xyz data for each population of interest \nEnvData <- read.table(\"ENV_dataGBR.txt\",header=T,sep=\"\\t\")\n\n\n#NPOPS <- nrow(EnvData)  \n\nminx <- min(EnvData$x)-0.005  # farthest west\nminy <- min(EnvData$y)-0.005  # farthest south\nmaxx <- max(EnvData$x)+0.005  # farthest east\nmaxy <- max(EnvData$y)+0.005  # farthest north\nstudyRegion <- extent(minx,maxx,miny,maxy)\ncat(sprintf(\"Western margin is %s degrees, southern margin is %s degrees, eastern margin is %s degrees, and northern margin is %s degrees\",minx,miny,maxx,maxy))\n\nplot(studyRegion, main=\"Study Region (blank)\")\n\n# save study region extent (as \"extent\" object)\nsetwd(SPATIALDATA_DIRECTORY)\nsave(studyRegion,file=\"studyRegion.RData\")\n\n\ntemplate <- raster(ext=studyRegion,resolution=0.01,vals=0, crs = projection)   # create empty raster\n#template001 <- raster(ext=studyRegion,resolution=0.001,vals=0, crs = projection)   # create empty raster at 0.001 res\n#plot(template)\nsetwd(SPATIALDATA_DIRECTORY)\nwriteRaster(template,filename=\"templateRaster.asc\",format=\"ascii\",overwrite=T)   # write to file\n\n##################\n## create reefraster from GBRMPA Classification at 0.001 resolution\n##################\nreefshape <- readShapefile(\"MarineBioregions_WGS84\", projection = projection, plot=T)\nreefraster001 <- rasterize(reefshape, template001, field = \"REEF_ID\", crs = projection)\nsetwd(SPATIALDATA_DIRECTORY)\nwriteRaster(reefraster,filename=\"reefraster001.asc\",format=\"ascii\",overwrite=T)   # write to file\n\nsummary(reefshape)\nsum(reefpercent@data@values>50)\n##################\n## Create ReefPercent Raster (aggregate reefraster to 0.01 resolution to calculate percent reef in each 0.01 cell)\n##################\n\nreefraster01 <- reclassify(reefraster001,rcl=c(NA,NA,0, -Inf,0.5,0, 0.501,Inf,1))  # temporary layer: reclassify to binary\ncompute_percentReef <- function(t,na.rm=TRUE) sum(t,na.rm)  ## aggregation function\nreefpercent <- aggregate(reefraster01, fact=10, fun=compute_percentReef, expand=TRUE, na.rm=TRUE) \nreefpercent <- reefpercent-1    # for some reason, the result ends up between 1 and 101- reformulate for proper percent\nplot(reefpercent)\nsetwd(SPATIALDATA_DIRECTORY)\nwriteGDAL(reefpercent, fnam=\"reefpercent.tif\", drivername = \"GTiff\", type = \"Float32\")\nwriteRaster(reefpercent,filename=\"reefPercentRaster.tif\",format=\"GTiff\",overwrite=T)   # write to file\n\n\n\n##################\n## Create ReefBioregion ReefID raster files  \n##################\n\nreefbioregion <- rasterize(reefshape, template, field = \"BIOREGION\")\nwriteRaster(reefbioregion,filename=\"reefbioregion.asc\",format=\"ascii\",overwrite=T)\n\nreefID <- rasterize(reefshape, template, field = \"OBJECTID\")\nwriteRaster(reefID,filename=\"reefID.asc\",format=\"ascii\",overwrite=T)\n\n##################\n## create a XYZ grid from reefshape keeping all fields\n##################\nreefpercent.df <- data.frame(data.frame(x = coordinates(reefpercent)[,1], y = coordinates(reefpercent)[,2], reefpercent = reefpercent@data@values))\nreefpercent.df <- subset(reefpercent.df, reefpercent>0)\ncoords <- reefpercent.df[,1:2]\nsp <- SpatialPoints(coords = coords, proj4string = CRS(projection))\n\n#extract vals from shapefile for every pixel that contains reef\nvals <- over(sp, reefshape)\nreefs <- cbind(coordinates(sp), vals, reefpercent = reefpercent.df[,3])\n\n#create subset of pixels that contain reef but aren't assigned attributes\nreef.NA <- subset(reefs, is.na(REEF_ID))\n#creat subset that do have attributes\nreef.YES <- subset(reefs, !is.na(REEF_ID))\n#convert both the spatial points dataframes to determine the geographic distance between them\ncoordinates(reef.NA) <- ~x+y; coordinates(reef.YES) <- ~x+y\nGdist <- gDistance(reef.NA,reef.YES, byid = T)\nmin.d <- apply(Gdist, 2, which.min) #creates vector of the minimum distances which we use to index the cords \nmin.gd <- apply(Gdist, 2, min) #creates a vecor of the min dist so we can see how far they have been displaced\n\nreef.NA$min.gd <- min.gd\nsummary(min.gd)\n#Double check that the matches are ok\nreef.NAdf <- as.data.frame(reef.NA)\nreef.YESdf <- as.data.frame(reef.YES)\ncoord.matches <- cbind(reef.NAdf[,1:2],reef.YESdf[min.d,1:2], min.gd)\n\n#For now I'll just discard reefs that have no info from the associated polygons\n\n##################\n#Check how all shapefiles, rasters and environmental data line up\n##################\n#\n# THis section is used to make sure we have all the correct data for every reef cell\n# At the moment a lot of reef cells -- especially those with high reef percentage are not represented in our enviro data\n# This means we may have to interpolate the dataset further - we only have data for about 1/3\nenvcoords <- EnvData[,2:3]\nenvpoints <- SpatialPoints(coords = envcoords, proj4string = CRS(projection))\n\n\nplotzoom <- function (zoomextent) {\n  \n  \n  plot(reefpercent, xlim=c(zoomextent[1],zoomextent[2]), ylim=c(zoomextent[3],zoomextent[4]))\n  #plot(reefraster001, xlim=c(zoomextent[1],zoomextent[2]), ylim=c(zoomextent[3],zoomextent[4]), add = TRUE)\n  plot(reefshape, xlim=c(zoomextent[1],zoomextent[2]), ylim=c(zoomextent[3],zoomextent[4]), add = TRUE)\n  points(sp, xlim=c(zoomextent[1],zoomextent[2]), ylim=c(zoomextent[3],zoomextent[4]), pch=20, col=\"blue\", cex=0.5)\n  points(envpoints, xlim=c(zoomextent[1],zoomextent[2]), ylim=c(zoomextent[3],zoomextent[4]), pch=17, col=\"red\", cex=0.5)\n}\nwindows()\nplotzoom(c(151.4, 151.8, -23.03,-22.55))\n\n\nplot(reefpercent)\nplot(reefshape, add=T)\npoints(envpoints, pch=17, col=\"blue\", cex=0.)\n\n\n#merge env data with reef data\n\ndata <- merge(reef.YESdf, EnvData, by = c(\"x\", \"y\"))\nsetwd(DATA_DIRECTORY)\nwrite.table(data, \"ENVData_all.txt\", row.names = F, sep = \"\\t\")\n\n\n\n\ntotalCells <- length(template@data@values)    # 1,335,372 cells\ncat(sprintf(\"total cells in study region raster is %s\",totalCells))\n\n\n################\n### Create Reef ID layer for the GBR\n################\n\n## rasterize an XYS variable.\nreefID <- as.numeric(PopData$REEF_ID)\nndx <- !is.na(reefID)\nreefIDraster <- rasterize(PopData[,c('x','y')][ndx,], template, field=reefID[ndx])   # memory limitations\n\nsetwd(SPATIALDATA_DIRECTORY)\nwriteRaster(reefIDraster,filename=\"reefIDRaster.asc\",format=\"ascii\",overwrite=T)   # write to file\nplot(reefIDraster)\n\nrm(reefIDraster)\n\n\nReadRaster(\"reefraster2.asc\", projection = projection, plot=t)\n",
    "created" : 1475101046695.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "515119176",
    "id" : "53F6245B",
    "lastKnownWriteTime" : 1475101089,
    "path" : "~/GitHub/COTS_popmodel/COTSMOdel_GISWorking.R",
    "project_path" : "COTSMOdel_GISWorking.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 12,
    "source_on_save" : false,
    "type" : "r_source"
}